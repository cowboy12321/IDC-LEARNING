# CLIP4IDC 模型架构详解

CLIP4IDC 是一种基于 CLIP 的图像描述变化（Image Difference Captioning, IDC）方法，旨在克服传统 IDC 方法的三个瓶颈：  
1. 特征提取过程中梯度无法传播的问题。  
2. 预训练与 IDC 微调之间目标和数据域的不匹配。  
3. 视觉特征仅局限于视觉域，与文本域的距离较大。  

模型架构分为以下部分：  

---

## 1. 模型的整体结构
如图 2 所示，CLIP4IDC 模型包括两个主要部分：  
- **视觉编码器（Vision Encoder）**：负责从图像对中提取特征，捕捉图像间的细微变化。  
- **语言编码器（Language Encoder）**：将输入文本（如差异描述）编码为特征表示，用于指导生成。     

此外，模型通过多层 Transformer 编码器和解码器处理视觉和文本特征，实现跨模态的联合优化。  

---

## 2. 语言编码器
语言编码器基于 Transformer，输入为文本差异描述 \(T\)，例如“棕色的哑光立方体变成了绿色”。主要步骤：  
1. 文本序列被转化为嵌入表示，包括起始标记（BOS）、结束标记（EOS）和每个词的词嵌入。  
2. 加入位置嵌入 \(p_T\) 来保留序列的位置信息。    
3.  最终经过（N-G） 层 Transformer 后，输出最终的文本特征表示 (g)。  

公式如下：

\[G(T) = G(\{E_{\text{BOS}}, E_{t1}, ..., E_{tm}, E_{\text{EOS}}\} + p_T)\]

---

## 3. 视觉编码器
视觉编码器由 CLIP 初始化，用于提取图像对 \((X_1, X_2)\) 的特征，分为两部分：**Intra 模块**和**Inter 模块**。  

### 3.1 图像特征提取
- 图像被分割为若干图像块（patch），并加入位置嵌入 \(p_I\)，形成序列表示。
- 每张图像的全局上下文由一个特殊的类标记（CLS token）嵌入表示。

公式如下：

\[X_1 = \{x_{\text{cls}}, x^1_1, ..., x^1_n\} + p_I\]

\[
X_2 = \{x_{\text{cls}}, x^2_1, ..., x^2_n\} + p_I
\]

### 3.2 Intra 模块（单模态上下文学习）
包含 \(N_{\text{intra}}\) 层 Transformer，分别从图像对中提取单模态上下文特征。

### 3.3 Inter 模块（跨模态上下文对比）
包含 \(N_{\text{inter}}\) 层 Transformer，重点捕捉图像对中表示的细微差异。

公式表示：

\[
F(X_1, X_2) = F_{\text{inter}}(\{F_{\text{intra}}(X_1) + e_1, F_{\text{intra}}(X_2) + e_2\} + p)
\]

其中 \(e_1\) 和 \(e_2\) 是特殊标记，用于分别表示第一张和第二张图像。

### 3.4 视觉特征映射到文本域
视觉特征经过线性变换 \(W \in \mathbb{R}^{d_I \times d_T}\)，生成最终的视觉表示 \(F'(X_1, X_2)\)。

---

## 4. IDC 特定的适配
为了更好地适应 IDC 任务，CLIP4IDC 引入了两个预训练任务：  
1. **图像对到文本（IP-T）检索**：  
   - 目标是让图像对的差异表示接近对应的文本描述表示。  
2. **文本到图像对（T-IP）检索**：  
   - 目标是让文本描述的表示接近对应图像对的差异表示。  

两者均采用对比学习的方法，通过余弦相似度计算匹配程度，并使用可学习的温度参数 \(\tau\) 平滑梯度。  

### 损失函数
总损失函数定义为：

\[
L = L_{\text{IP-T}} + L_{\text{T-IP}}
\]

其中：

\[
L_{\text{IP-T}} = -\frac{1}{B} \sum_{i=1}^{B} \log \frac{\exp(s(v_i, g_i) / \tau)}{\sum_{j=1}^{B} \exp(s(v_i, g_j) / \tau)}
\]

\[
L_{\text{T-IP}} = -\frac{1}{B} \sum_{i=1}^{B} \log \frac{\exp(s(v_i, g_i) / \tau)}{\sum_{j=1}^{B} \exp(s(v_j, g_i) / \tau)}
\]

---

## 5. 总结
CLIP4IDC 通过结合 CLIP 预训练的强大视觉语言表征能力，设计了针对 IDC 任务的改进架构：  
- 利用 Intra 和 Inter 模块捕捉图像对中的细微差异。  
- 通过 IP-T 和 T-IP 检索任务优化跨模态表示。  
- 最终，生成更加准确的图像变化描述。  

